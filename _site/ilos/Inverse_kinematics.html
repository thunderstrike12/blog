<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&display=swap" as="style" type="text/css" crossorigin>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#FFA500">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="/assets/css/style.css?v=b684136464bd82795e25e400c8dbafd6ca28cb1e">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    
    <header class="page-header" role="banner">
      <h1 style="color: white;" class="project-name">Inverse Kinematics</h1>
      <h2 style="color: white;">
        <a class="author" href="mailto: .buas.nl">Loek van der Beele</a>
      </h2>
      <h2 style="color: white;"></h2>
      <a href="/" class="btn"> üè† </a>

      
        <a href="/ilos/Inverse_kinematics.html" class="btn"> ü§ñ IK</a>
      
    </header>

    <div class="site-name">
      <a href="/" title="Return to the homepage">Blog</a>
    </div>

    <main id="content" class="main-content" role="main">
      <h3 id="introduction">Introduction</h3>

<p>In this post about Inverse Kinematics I will demonstrate how I‚Äôve made my Inverse Kinematics. An important heads up is that I am using an ECS and the algorithm I used for my Inverse Kinematics is the FABRIK algorithm.</p>

<h3 id="forward-kinematics">Forward kinematics</h3>

<p>Before we get into the actual Inverse Kinematics we will first take a look at some 2D forward kinematcs. The algorithm for forward kinematics is quite simple. All I do is give one segment an angle to rotate with and all following segments will rotate with the same angle. After this we move every segment to the end of the previous segment. In code That looks something like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">auto</span> <span class="n">t1_curr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">Transform</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="k">auto</span> <span class="n">t1_prev</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">s1_prev</span> <span class="o">=</span> <span class="n">Segment</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">t1_prev</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">Transform</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
            <span class="n">s1_prev</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">Segment</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
            <span class="n">t1_curr</span><span class="o">-&gt;</span><span class="n">SetTranslation</span><span class="p">(</span><span class="n">t1_prev</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">+</span> <span class="n">t1_prev</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">()</span> <span class="o">*</span> <span class="n">forward</span> <span class="o">*</span> <span class="n">s1_prev</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">t1_curr</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">angle</span> <span class="o">*</span> <span class="n">t1_curr</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">());</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>Before I do that, I also do a check to see if the angle is greater than the maximum angle the segment can go. To do this, I get the current angle between two quaternions. If the angle has passed the maximum, I check if the new angle angle is smaller than both the maximum angle and the old rotation, otherwise I clamp the new rotation to the maximum angle. This is to make sure that the arm does not get stuck past the max angle because it isn‚Äôt allowed to move anymore. Below you can see what that looks like in code:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kt">float</span> <span class="n">dot_product</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">()),</span> <span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">t_prev</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">()));</span>
<span class="kt">float</span> <span class="n">old_angle</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">acos</span><span class="p">(</span><span class="n">dot_product</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">old_angle</span> <span class="o">&gt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">max_angle</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Transform</span> <span class="n">test_t</span> <span class="o">=</span> <span class="o">*</span><span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">try_get</span><span class="o">&lt;</span><span class="n">Transform</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">test_t</span><span class="p">.</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">angle</span> <span class="o">*</span> <span class="n">test_t</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">());</span>
    <span class="n">dot_product</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">test_t</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">()),</span> <span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">t_prev</span><span class="o">-&gt;</span><span class="n">GetRotation</span><span class="p">()));</span>
    <span class="kt">float</span> <span class="n">new_angle</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">acos</span><span class="p">(</span><span class="n">dot_product</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">new_angle</span> <span class="o">&gt;</span> <span class="n">old_angle</span><span class="p">)</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">angle</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
<span class="p">}</span>

</code></pre></div></div>

<p>And a GIF  of forward kinematics in action:</p>

<p><img src="../assets/media/forward_kinematics.gif" alt="fwd_kine" /></p>

<h3 id="inverse-kinematics">Inverse Kinematics</h3>

<p><img src="../assets/media/visual.png" alt="visual" /></p>

<p><small>Note: this is which segment I mean with next or previous in the code. This is both in the forward and backwards reaching parts to avoid confusion while working on the algorithm.</small></p>

<p>For the FABRIK algorithm, there are two main parts; the forward reaching and backwards reaching part. In the forward reaching part I set each segments position equal to the previous segments end position, and I point the segment to the base of the next segment.</p>

<p>For the segment at the end of the arm, I set it‚Äôs position equal to the effector instead.</p>

<p>And for the segment connected to the base, I point it to the base instead.</p>

<p>All this can be seen below. Note that this is a very simplified version of the actual code.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetTranslation</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">effector</span><span class="p">);</span>
            <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">effector</span> <span class="o">-</span> <span class="n">t_next</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">())</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">DirectionToQuaternion</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetTranslation</span><span class="p">(</span><span class="n">t_prev</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">+</span> <span class="n">t_prev</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">()</span> <span class="o">*</span> <span class="n">forward</span> <span class="o">*</span> <span class="n">s_prev</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
            <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">-</span> <span class="n">arm</span><span class="p">.</span><span class="n">base</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">DirectionToQuaternion</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetTranslation</span><span class="p">(</span><span class="n">t_prev</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">+</span> <span class="n">t_prev</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">()</span> <span class="o">*</span> <span class="n">forward</span> <span class="o">*</span> <span class="n">s_prev</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
            <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">dir</span> <span class="o">=</span> <span class="o">-</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_next</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">())</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">DirectionToQuaternion</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>For the backwards part, I set the segment equal to end point of the next segment and point it to the base of the previous segment. Pretty similar to the previous loop, but an important difference here is that this loop increments i after each iteration, instead of decrementing, like in the previous loop.</p>

<p>In this loop the segment at the end of the arm it points to the effector instead of the base of the previous segment.</p>

<p>The position of the segment at the base of the arm is set equal to the base of the arm instead of the end point of the next segment.</p>

<p>The code for the backwards part can be seen below.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">arm</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetTranslation</span><span class="p">(</span><span class="n">t_next</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">+</span> <span class="n">t_next</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">()</span> <span class="o">*</span> <span class="n">forward</span> <span class="o">*</span> <span class="n">s_next</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
            <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">-</span> <span class="n">arm</span><span class="p">.</span><span class="n">effector</span><span class="p">));</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">DirectionToQuaternion</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetTranslation</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">base</span><span class="p">);</span>
            <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">arm</span><span class="p">.</span><span class="n">base</span> <span class="o">-</span> <span class="n">t_prev</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()));</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">DirectionToQuaternion</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetTranslation</span><span class="p">(</span><span class="n">t_next</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">+</span> <span class="n">t_next</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">()</span> <span class="o">*</span> <span class="n">forward</span> <span class="o">*</span> <span class="n">s_next</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
            <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="o">-</span><span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_prev</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()));</span>
            <span class="n">t</span><span class="o">-&gt;</span><span class="n">SetRotation</span><span class="p">(</span><span class="n">DirectionToQuaternion</span><span class="p">(</span><span class="n">dir</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>To add a segment to an arm I have made a function to add a segment to it‚Äôs respective arm. This function can be seen below. This is to make the library a lot more usable.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">ArmInverse</span><span class="o">::</span><span class="n">AddSegment</span><span class="p">(</span><span class="kt">float</span> <span class="n">length</span><span class="p">,</span> <span class="kt">float</span> <span class="n">width</span><span class="p">,</span> <span class="kt">float</span> <span class="n">max_angle</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">preferred_direction</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_path</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">auto</span> <span class="n">segment_entity</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateEntity</span><span class="p">();</span>
    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">Segment</span><span class="o">&gt;</span><span class="p">(</span><span class="n">segment_entity</span><span class="p">);</span>
    <span class="n">seg</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
    <span class="n">seg</span><span class="p">.</span><span class="n">max_angle</span> <span class="o">=</span> <span class="n">max_angle</span><span class="p">;</span>
    <span class="n">seg</span><span class="p">.</span><span class="n">preferred_direction</span> <span class="o">=</span> <span class="n">preferred_direction</span><span class="p">;</span>
    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">trans</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">bee</span><span class="o">::</span><span class="n">Transform</span><span class="o">&gt;</span><span class="p">(</span><span class="n">segment_entity</span><span class="p">);</span>
    <span class="n">trans</span><span class="p">.</span><span class="n">SetScale</span><span class="p">({</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">length</span> <span class="o">/</span> <span class="mf">2.0</span><span class="n">f</span><span class="p">});</span>
    <span class="n">segment</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">segment_entity</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">file_path</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">auto</span><span class="o">&amp;</span> <span class="n">mesh_renderer</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">bee</span><span class="o">::</span><span class="n">MeshRenderer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">segment_entity</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">box_model</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">Resources</span><span class="p">().</span><span class="n">Load</span><span class="o">&lt;</span><span class="n">bee</span><span class="o">::</span><span class="n">Model</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bee</span><span class="o">::</span><span class="n">FileIO</span><span class="o">::</span><span class="n">Directory</span><span class="o">::</span><span class="n">SharedAssets</span><span class="p">,</span> <span class="n">file_path</span><span class="p">);</span>
        <span class="n">mesh_renderer</span><span class="p">.</span><span class="n">Material</span> <span class="o">=</span> <span class="n">box_model</span><span class="o">-&gt;</span><span class="n">GetMaterials</span><span class="p">()[</span><span class="mi">0</span><span class="p">];</span>
        <span class="n">mesh_renderer</span><span class="p">.</span><span class="n">Mesh</span> <span class="o">=</span> <span class="n">box_model</span><span class="o">-&gt;</span><span class="n">GetMeshes</span><span class="p">()[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">seg</span><span class="p">.</span><span class="n">has_model</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="loading-rigs-from-blender">Loading rigs from Blender</h3>

<p>For the loading of the rigs from blender, I first read the file, and store all the bones in a vector with all the data I will need.</p>

<p>I will assert if <code class="language-plaintext highlighter-rouge">bones</code> is empty, because this means the file that has been passed is invalid.</p>

<p>The <code class="language-plaintext highlighter-rouge">pop_back()</code> at the end is because before going into the skins section there is an armature section, wich it will also store. We can just simply remove the last element to fix this, because every file has this.</p>

<p>This can be seen below;</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Rig</span><span class="o">::</span><span class="n">Rig</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">file_path</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">data</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">FileIO</span><span class="p">().</span><span class="n">ReadTextFile</span><span class="p">(</span><span class="n">FileIO</span><span class="o">::</span><span class="n">Directory</span><span class="o">::</span><span class="n">SharedAssets</span><span class="p">,</span> <span class="n">file_path</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">istringstream</span> <span class="n">stream</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">line</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">inNodesSection</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">currentTranslation</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">nodes</span><span class="se">\"</span><span class="s">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">inNodesSection</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">inNodesSection</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"skins"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">inNodesSection</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"{"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">bones</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">id_count</span><span class="p">});</span>
                <span class="n">id_count</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">name</span><span class="se">\"</span><span class="s">:</span><span class="se">\"</span><span class="s">Bone"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">removeNonNumbers</span><span class="p">(</span><span class="n">line</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">bones</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">name</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"children"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">;</span>
                <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">value</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">remove_if</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="o">::</span><span class="n">isspace</span><span class="p">),</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"]"</span><span class="p">)</span> <span class="o">==</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">stoi</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
                    <span class="p">}</span>
                    <span class="k">else</span>
                    <span class="p">{</span>
                        <span class="n">bones</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">child</span> <span class="o">=</span> <span class="n">values</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">translation</span><span class="se">\"</span><span class="s">"</span><span class="p">)</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">value</span><span class="p">;</span>
                <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>

                <span class="k">while</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">getline</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">value</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">remove_if</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="o">::</span><span class="n">isspace</span><span class="p">),</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>

                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
                    <span class="p">{</span>
                        <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">stof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
                    <span class="p">{</span>
                        <span class="n">currentTranslation</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
                        <span class="n">bones</span><span class="p">.</span><span class="n">back</span><span class="p">().</span><span class="n">translation</span> <span class="o">=</span> <span class="n">currentTranslation</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">bones</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="s">"invalid file"</span><span class="p">);</span>
    <span class="n">bones</span><span class="p">.</span><span class="n">pop_back</span><span class="p">();</span>
</code></pre></div></div>

<p><img src="../assets/media/visual2.png" alt="visual2" /></p>

<p>Next I determine what the parent should be for every bone. In the same loop, I also create new arms if the arm splits up into 2 or more other arms. For this, I need to make a new arm entity, which can be seen above. Every arm that splits off into multiple arms is it‚Äôs own arm, that in turn can have as many segments as needed. In the image above every color represents it‚Äôs own arm, and in the code below I generate an arm eveytime there is a split.</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kt">int</span> <span class="n">arm_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bones</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">[</span><span class="n">j</span><span class="p">]].</span><span class="n">isNewArm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">[</span><span class="n">j</span><span class="p">]].</span><span class="n">is_added</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">arm_entity</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">entt</span><span class="o">::</span><span class="n">null</span><span class="p">);</span>
                <span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateEntity</span><span class="p">();</span>
                <span class="k">auto</span><span class="o">&amp;</span> <span class="n">arm_comp</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">]);</span>
                <span class="n">arm_comp</span><span class="p">.</span><span class="n">AddSegment</span><span class="p">(</span><span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.1</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="s">"models/BoxAndCylinder.gltf"</span><span class="p">);</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">[</span><span class="n">j</span><span class="p">]].</span><span class="n">arm_entity</span> <span class="o">=</span> <span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">];</span>
                <span class="n">arm_count</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">int</span> <span class="n">bone_id</span> <span class="o">=</span> <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
            <span class="n">bones</span><span class="p">[</span><span class="n">bone_id</span><span class="p">].</span><span class="n">parent</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>To make sure we have all the arms, we also need to make sure we have the starting points of an arm, not were there is a split, but if a bone does not have a parent, that is where we also need to add an arm entity. It is possible we handle a child of such a segment before the arm is created. in this case, we need to go to said segment(the parent of the segment we‚Äôre currently handling), create the arm, and then add the segment for it, after that we can add the segment we initially wanted to add.</p>

<p>After this loop we have created all the segments we wanted to add.</p>

<p>The code can be seen below;</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bones</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_added</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">isNewArm</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_added</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="n">arm_entity</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">entt</span><span class="o">::</span><span class="n">null</span><span class="p">);</span>
                <span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateEntity</span><span class="p">();</span>
                <span class="k">auto</span><span class="o">&amp;</span> <span class="n">arm_comp</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">]);</span>
                <span class="n">arm_comp</span><span class="p">.</span><span class="n">AddSegment</span><span class="p">(</span><span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.1</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="s">"models/BoxAndCylinder.gltf"</span><span class="p">);</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arm_entity</span> <span class="o">=</span> <span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">];</span>
                <span class="n">arm_count</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_added</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bones</span><span class="p">[</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent</span><span class="p">].</span><span class="n">arm_entity</span> <span class="o">==</span> <span class="n">entt</span><span class="o">::</span><span class="n">null</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="kt">int</span> <span class="n">parent_id</span> <span class="o">=</span> <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent</span><span class="p">;</span>
                    <span class="n">bones</span><span class="p">[</span><span class="n">parent_id</span><span class="p">].</span><span class="n">is_added</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="n">arm_entity</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">entt</span><span class="o">::</span><span class="n">null</span><span class="p">);</span>
                    <span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateEntity</span><span class="p">();</span>
                    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">arm_comp</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">]);</span>
                    <span class="n">arm_comp</span><span class="p">.</span><span class="n">AddSegment</span><span class="p">(</span><span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.1</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="s">"models/BoxAndCylinder.gltf"</span><span class="p">);</span>
                    <span class="n">bones</span><span class="p">[</span><span class="n">parent_id</span><span class="p">].</span><span class="n">arm_entity</span> <span class="o">=</span> <span class="n">arm_entity</span><span class="p">[</span><span class="n">arm_count</span><span class="p">];</span>
                    <span class="n">arm_count</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arm_entity</span> <span class="o">=</span> <span class="n">bones</span><span class="p">[</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent</span><span class="p">].</span><span class="n">arm_entity</span><span class="p">;</span>
                <span class="k">auto</span><span class="o">&amp;</span> <span class="n">arm_comp</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arm_entity</span><span class="p">);</span>
                <span class="n">arm_comp</span><span class="p">.</span><span class="n">AddSegment</span><span class="p">(</span><span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.1</span><span class="n">f</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="s">"models/BoxAndCylinder.gltf"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To make sure all the seperate arms stick together there is a rig manager system that updates all the rigs to stick all the arms together at the correct position.</p>

<p>code for this can be seen below;</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="n">RigManager</span><span class="o">::</span><span class="n">Update</span><span class="p">(</span><span class="kt">float</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="p">[</span><span class="n">entity</span><span class="p">,</span> <span class="n">rig</span><span class="p">]</span> <span class="o">:</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">view</span><span class="o">&lt;</span><span class="n">Rig</span><span class="o">&gt;</span><span class="p">().</span><span class="n">each</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">arm_comp</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arm_entity</span><span class="p">);</span>
                    <span class="k">auto</span><span class="o">&amp;</span> <span class="n">arm_comp1</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">[</span><span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">child</span><span class="p">[</span><span class="n">j</span><span class="p">]].</span><span class="n">arm_entity</span><span class="p">);</span>

                    <span class="k">auto</span> <span class="n">trans</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">Transform</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm_comp</span><span class="p">.</span><span class="n">segment</span><span class="p">[</span><span class="n">arm_comp</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]);</span>
                    <span class="k">auto</span> <span class="n">seg</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">Segment</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm_comp</span><span class="p">.</span><span class="n">segment</span><span class="p">[</span><span class="n">arm_comp</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]);</span>
                    <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">forward</span> <span class="o">=</span> <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
                    <span class="n">glm</span><span class="o">::</span><span class="n">vec3</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">trans</span><span class="p">.</span><span class="n">GetTranslation</span><span class="p">()</span> <span class="o">+</span> <span class="n">glm</span><span class="o">::</span><span class="n">normalize</span><span class="p">(</span><span class="n">trans</span><span class="p">.</span><span class="n">GetRotation</span><span class="p">()</span> <span class="o">*</span> <span class="n">forward</span><span class="p">)</span> <span class="o">*</span> <span class="n">seg</span><span class="p">.</span><span class="n">length</span> <span class="o">*</span> <span class="mf">0.5</span><span class="n">f</span><span class="p">;</span>

                    <span class="n">arm_comp1</span><span class="p">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">parent</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">Registry</span><span class="p">.</span><span class="n">get</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rig</span><span class="p">.</span><span class="n">bones</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">arm_entity</span><span class="p">).</span><span class="n">base</span> <span class="o">=</span> <span class="n">rig</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="usability-of-library">Usability of Library</h3>

<p>Rigs can be loaded from blender quite easily by making an entity and adding a rig component with a file path as argument like this:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">rig</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateEntity</span><span class="p">();</span>
<span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">Rig</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rig</span><span class="p">,</span> <span class="s">"models/test.gltf"</span><span class="p">);</span>
</code></pre></div></div>

<p>The model will now bee in bee with a base and control points that can be adjusted in game code.</p>

<p>Below can be seen what that could look like;</p>

<p><img src="../assets/media/blentobee.png" alt="b2b" /></p>

<p><img src="../assets/media/human_walk.gif" alt="human" /></p>

<p>If you don‚Äôt want/need to load a complete rig, but just one arm, that is also possible. This can be done by making an entity and adding the arm component to it. To add more segments, you can call a function on the component. Below you can see what this looks like in code;</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">auto</span> <span class="n">arm</span> <span class="o">=</span> <span class="n">bee</span><span class="o">::</span><span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateEntity</span><span class="p">();</span>
<span class="k">auto</span><span class="o">&amp;</span> <span class="n">arm_comp</span> <span class="o">=</span> <span class="n">Engine</span><span class="p">.</span><span class="n">ECS</span><span class="p">().</span><span class="n">CreateComponent</span><span class="o">&lt;</span><span class="n">ArmInverse</span><span class="o">&gt;</span><span class="p">(</span><span class="n">arm</span><span class="p">);</span>

<span class="n">arm_comp</span><span class="p">.</span><span class="n">AddSegment</span><span class="p">(</span><span class="mf">1.0</span><span class="n">f</span><span class="p">,</span> <span class="mf">0.07</span><span class="n">f</span><span class="p">,</span> <span class="n">glm</span><span class="o">::</span><span class="n">pi</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="p">(),</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="n">f</span><span class="p">},</span> <span class="s">"models/BoxAndCylinder.gltf"</span><span class="p">);</span>
</code></pre></div></div>


      <footer class="site-footer">
        
          <span class="site-footer-owner"><a href="https://github.com/thunderstrike12/blog">blog</a> is maintained by <a href="https://github.com/thunderstrike12">thunderstrike12</a>.</span>
        
        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
      </footer>
    </main>
  </body>
</html>